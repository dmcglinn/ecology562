<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<title>Assignment 6&mdash;Solution</title>
<link rel="stylesheet" type="text/css" href="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/css/green.css" title="green" /> 
<link rel="stylesheet" type="text/css" href="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/css/calendar.css" title="calendar" /> 
<link rel="alternate stylesheet" type="text/css" media="all" href="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/css/purple.css" title="purple" /> 
<link rel="alternate stylesheet" type="text/css" media="all" href="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/css/large.css" title="large" /> 
<link rel="alternate stylesheet" type="text/css" media="all" href="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/css/reverse.css" title="reverse" /> 
<!-- the @import method only works from 5.0 and upwards  -->
<!-- so, using @import would "hide" the more sophisticated sheet from < 5.0 browsers -->
<!-- <style type="text/css" media="all">@import "fancy_style.css";</style> -->
<script language="JavaScript" type="text/javascript" src="https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/js/styleswitcher.js"></script> 
<style type="text/css">
<!--
div.figure {float:none;width=25%;} 
div.figure p {test-align: center;font-style:italic;}
div.figureL {float:left;width=50%; margin:1.5em;padding:4px 4px 4px 0px;} 
div.figureL p {test-align: center;font-style:italic;}
div.figureR {float:right;width=50%;margin:1.5em;padding:4px 4px 4px 0px;} 
div.figureR p {test-align: center;font-style:italic;}
.style1 {font-family: "Courier New", Courier, mono}
.style2 {
	color: #0000FF;
	font-family: "Courier New", Courier, mono;
	font-size: smaller;
}
.style7 {font-family: "Courier New", Courier, mono; color: #00CC00; }

.style8 {
	font-family: Arial, Helvetica, sans-serif;
	color: #810000;
}
.style11 {font-family: "Courier New", Courier, mono;}
.style22 {color: #663366; font-weight: bold; }
.style10 {
	font-family: "Courier New", Courier, mono;
	color: #000000;
	background-color:#F0F0F0;
}
.style33 {
	font-family: "Courier New", Courier, mono;
	color: #000000;
	background-color:#FFFACD;
}
.style15 {font-family: "Courier New", Courier, mono; color: #339933; font-weight: bold; background-color:#F0F0F0; }

.style34 {font-family: "Courier New", Courier, mono; color: #339933; font-weight: bold; background-color:#FFFACD; }
.style43 {color: #0000FF; font-weight: bold; font-family: "Courier New", Courier, mono;  background-color:#FFFACD;}

.style19 {color: #339933;
	font-weight: bold;}

.style24 {
	font-family: "Courier New", Courier, mono;
	color: #0000FF;
	font-size:small;
}


a:link {color: #0000CC; text-decoration:none}
a:visited {color: #0000CC; text-decoration:none}
a:hover {color: green; text-decoration:underline; background:#F9EDED}
a:active {color: red; text-decoration:none}
.style16 {font-size: larger}
.style18 {color: #009966; font-weight: bold; font-family: "Courier New", Courier, mono; font-size: smaller; }
.style6 {color: #CC0033}
.style4 {	color: #CC0000;
	font-weight: bold;
}
.style25 {
	font-family: "Courier New", Courier, mono;
	color: #0000FF;
	background-color:#FFFC9A;
	font-size:small;
}

.styleArial {
	font-family: Arial, Helvetica, sans-serif;font-size:11.0pt;
}
-->
</style>
</head>


<body>
<h1 align="center"><a name="assign5" id="assign6"></a>Assignment 6&mdash;Solution</h1>

<div class="style10" style="padding-left: 30px; text-indent:-30px">co2 &lt;- read.table('ftp://ftp.cmdl.noaa.gov/ccg/co2/trends/co2_mm_mlo.txt', na.strings='-99.99')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> names(co2) &lt;- c('year', 'month', 'decimal.date', 'average', 'interpolated', 'trend', 'days')</div>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> co2$ID &lt;- 1:nrow(co2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> co2[1:4,]</div>
<span class="style24">  &nbsp; year month decimal.date average interpolated&nbsp; trend days ID<br>
  1 1958&nbsp;&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp; 1958.208&nbsp; 315.71&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 315.71 314.61&nbsp;&nbsp; -1&nbsp; 1<br>
  2 1958&nbsp;&nbsp;&nbsp;&nbsp; 4&nbsp;&nbsp;&nbsp;&nbsp; 1958.292&nbsp; 317.45&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 317.45 315.29&nbsp;&nbsp; -1&nbsp; 2<br>
  3 1958&nbsp;&nbsp;&nbsp;&nbsp; 5&nbsp;&nbsp;&nbsp;&nbsp; 1958.375&nbsp; 317.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 317.50 314.71&nbsp;&nbsp; -1&nbsp; 3<br>
  4 1958&nbsp;&nbsp;&nbsp;&nbsp; 6&nbsp;&nbsp;&nbsp;&nbsp; 1958.458&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 317.10 314.85&nbsp;&nbsp; -1&nbsp; 4</span> 
<h2>Question 1</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px">plot(average~decimal.date, data=co2, ylab=expression(paste('CO'[2],' level')), xlab='Year', type='l')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">abline(lm(average~decimal.date, data=co2), col=2)</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig1.png" width="460" height="300" alt="fig. 1"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 1 </strong> &nbsp;Raw data plus linear trend model</p></td>
  </tr>
</table>
<p>The plot shows a marked deviation from linearity.</p>
<h2>Question 2</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model1 &lt;- lm(average ~ decimal.date, data=co2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model2 &lt;- lm(average ~ decimal.date + I(decimal.date^2), data=co2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> anova(model1, model2)</div>
<span class="style24">Analysis of Variance Table</span>
<p><span class="style24">Model 1: average ~ decimal.date<br>
  Model 2: average ~ decimal.date + I(decimal.date^2)<br>
  &nbsp; Res.Df&nbsp;&nbsp;&nbsp; RSS Df Sum of Sq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F&nbsp;&nbsp;&nbsp; Pr(&gt;F)&nbsp;&nbsp;&nbsp; <br>
  1&nbsp;&nbsp;&nbsp; 638 7284.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
  2&nbsp;&nbsp;&nbsp; 637 3051.4&nbsp; 1&nbsp;&nbsp;&nbsp; 4232.5 883.57 </span><span class="style25">&lt; 2.2e-16</span><span class="style24"> ***<br>
  ---<br>
  Signif. codes:&nbsp; 0 &lsquo;***&rsquo; 0.001 &lsquo;**&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</span>
<p>The quadratic term is highly significant.</p>
<h2>Question 3</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px">data1 &lt;- data.frame(res=residuals(model2), ID=co2$ID[!is.na(co2$average)])</div>
 <div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">acf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 2 residuals', side=3, line=.5, cex=1)</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig2.png" width="460" height="320" alt="fig. 2"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 2 </strong> &nbsp;ACF for the model 2 residuals</p></td>
  </tr>
</table>
<p>The plot shows an obvious cycle at 12 months (the point at which the graph begins to repeat itself).</p>
<h2>Question 4</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model3 &lt;- update(model2, .~. + sin(2*pi/12*ID) + cos(2*pi/12*ID))</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> anova(model2, model3)</div>
<span class="style24">Analysis of Variance Table</span>
<p><span class="style24">Model 1: average ~ decimal.date + I(decimal.date^2)<br>
  Model 2: average ~ decimal.date + I(decimal.date^2) + sin(2 * pi/12 * <br>
  &nbsp;&nbsp;&nbsp; ID) + cos(2 * pi/12 * ID)<br>
  &nbsp; Res.Df&nbsp;&nbsp;&nbsp;&nbsp; RSS Df Sum of Sq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F&nbsp;&nbsp;&nbsp; Pr(&gt;F)&nbsp;&nbsp;&nbsp; <br>
  1&nbsp;&nbsp;&nbsp; 637 3051.41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
  2&nbsp;&nbsp;&nbsp; 635&nbsp; 532.88 &nbsp;2&nbsp;&nbsp;&nbsp; 2518.5 1500.6 </span><span class="style25">&lt; 2.2e-16</span><span class="style24"> ***<br>
  ---<br>
  Signif. codes:&nbsp; 0 &lsquo;***&rsquo; 0.001 &lsquo;**&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</span>
<p>The addition of the trigonometric terms of period 12 is highly significant.</p>
<h2>Question 5</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data1 &lt;- data.frame(res=residuals(model3), ID=co2$ID[!is.na(co2$average)])</div>

 <div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> acf(data3$res, na.action=na.pass, main='', lag.max=500)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 3 residuals', side=3, line=.5, cex=1)</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig3.png" width="460" height="320" alt="fig. 3"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 3 </strong> &nbsp;ACF for the model 3 residuals</p></td>
  </tr>
</table>
<p>Although things are damping down with time, it's pretty clear we have a cycle somewhere in excess of 300 months.</p>
<h2>Question 6</h2>
<p>I try fitting models with a period of 250 months up to a period of 400 months and save the AIC from each model.</p>

<div class="style10" style="padding-left: 30px; text-indent:-30px">my.aic&lt;-matrix(NA, ncol=2, nrow=151)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">  for(k in 250:400) {</div>
<div class="style10" style="padding-left: 60px; text-indent:-30px">  temp.model4 &lt;- update(model3, .~. + cos(2*pi/k*ID) + sin(2*pi/k*ID))</div>
<div class="style10" style="padding-left: 60px; text-indent:-30px">  my.aic[k-249,] &lt;- c(k, AIC(temp.model4))</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">}</div>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> which.min(my.aic[,2])</div>
 <span class="style24"> [1] 76</span>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> my.aic[76,]</div>
<span class="style24">  [1]&nbsp; 325.000 1484.963</span>
<div class="style10" style="padding-left: 30px; text-indent:-30px">plot(my.aic[,1], my.aic[,2], type='l', xlab='Period', ylab='AIC')</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig4.png" width="400" height="340" alt="fig. 4"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 4 </strong> &nbsp; AIC values for different periodic models, period 250 to 400</p></td>
  </tr>
</table>
<p>Although a period of 325 minimizes AIC, it's pretty clear from the graph that a number of other choices for the period would do nearly as well. This is not surprising given we  only have enough data to observe two  full cycles.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model4 &lt;- update(model3, .~. + sin(2*pi/325*ID) + cos(2*pi/325*ID))</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> anova(model3, model4)</div>
<span class="style24">Analysis of Variance Table</span>
<p><span class="style24">Model 1: average ~ decimal.date + I(decimal.date^2) + sin(2 * pi/12 * <br>
  &nbsp;&nbsp;&nbsp; ID) + cos(2 * pi/12 * ID)<br>
  Model 2: average ~ decimal.date + I(decimal.date^2) + sin(2 * pi/12 * <br>
  &nbsp;&nbsp;&nbsp; ID) + cos(2 * pi/12 * ID) + sin(2 * pi/325 * ID) + cos(2 * <br>
  &nbsp;&nbsp;&nbsp; pi/325 * ID)<br>
  &nbsp; Res.Df&nbsp;&nbsp;&nbsp; RSS Df Sum of Sq&nbsp;&nbsp;&nbsp;&nbsp; F&nbsp;&nbsp;&nbsp; Pr(&gt;F)&nbsp;&nbsp;&nbsp; <br>
  1&nbsp;&nbsp;&nbsp; 635 532.88&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
  2&nbsp;&nbsp;&nbsp; 633 371.98&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp; 160.9 136.9 </span><span class="style25">&lt; 2.2e-16</span><span class="style24"> ***<br>
  ---<br>
  Signif. codes:&nbsp; 0 &lsquo;***&rsquo; 0.001 &lsquo;**&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</span>
<p>The addition of the trigonometric terms of period 325 is highly significant.</p>
<h2>Question 7</h2>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> data1 &lt;- data.frame(res=residuals(model4), ID=co2$ID[!is.na(co2$average)])</div>

 <div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> acf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 4 residuals', side=3, line=.5, cex=1)</div><br>


<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig5.png" width="460" height="320" alt="fig. 5"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 5 </strong> &nbsp; ACF of the model 4 residuals</p></td>
  </tr>
</table>
<p>The graph shows an obvious cycle at six months.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model5 &lt;- update(model4, .~. + sin(2*pi/6*ID) + cos(2*pi/6*ID))</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> anova(model4, model5)</div>
<span class="style24">Analysis of Variance Table</span>
<p><span class="style24">Model 1: average ~ decimal.date + I(decimal.date^2) + sin(2 * pi/12 * <br>
  &nbsp;&nbsp;&nbsp; ID) + cos(2 * pi/12 * ID) + sin(2 * pi/325 * ID) + cos(2 * <br>
  &nbsp;&nbsp;&nbsp; pi/325 * ID)<br>
  Model 2: average ~ decimal.date + I(decimal.date^2) + sin(2 * pi/12 * <br>
  &nbsp;&nbsp;&nbsp; ID) + cos(2 * pi/12 * ID) + sin(2 * pi/325 * ID) + cos(2 * <br>
  &nbsp;&nbsp;&nbsp; pi/325 * ID) + sin(2 * pi/6 * ID) + cos(2 * pi/6 * ID)<br>
  &nbsp; Res.Df&nbsp;&nbsp;&nbsp; RSS Df Sum of Sq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F&nbsp;&nbsp;&nbsp; Pr(&gt;F)&nbsp;&nbsp;&nbsp; <br>
  1&nbsp;&nbsp;&nbsp; 633 371.98&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
  2&nbsp;&nbsp;&nbsp; 631 184.47&nbsp; 2&nbsp;&nbsp;&nbsp; 187.51 320.69 </span><span class="style25">&lt; 2.2e-16</span><span class="style24"> ***<br>
  ---<br>
  Signif. codes:&nbsp; 0 &lsquo;***&rsquo; 0.001 &lsquo;**&rsquo; 0.01 &lsquo;*&rsquo; 0.05 &lsquo;.&rsquo; 0.1 &lsquo; &rsquo; 1</span>
<p>The addition of the trigonometric terms of period 6 is highly significant.</p>
<h2>Question 8</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px">data1 &lt;- data.frame(res=residuals(model5), ID=co2$ID[!is.na(co2$average)])</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> acf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 5 residuals', side=3, line=.5, cex=1)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">pacf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 5 residuals', side=3, line=.5, cex=1)</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig6.png" width="460" height="320" alt="fig 6"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 6 </strong> &nbsp; ACF of the model 5 residuals</p></td>
  </tr>
</table>
<p>The decaying pattern of the ACF is highly suggestive of an autoregressive process.</p>
<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig7.png" width="460" height="320" alt="fig. 7"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 7 </strong> &nbsp; PACF of the model 5 residuals</p></td>
  </tr>
</table>
<p>The sharp spike at lag 1 in the PACF suggests that the autoregressive process may be AR(1). The fact that there are two much smaller significant spikes at lags 2 and 3 suggests we should also consider and AR(2) or AR(3). Because the drop from the first spike is sudden while the decay of spikes 2 and 3 is gradual, we might also consider adding some moving average terms.</p>
<h2>Question 9</h2>
<p>I start by fitting the last model using the <span class="style4">gls</span> function of the <span class="style19">nlme</span> package.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px">library(nlme)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">out.g &lt;- gls(average ~ decimal.date + I(decimal.date^2) + sin(2*pi/12*ID) + cos(2*pi/12*ID) + sin(2*pi/325*ID) + cos(2*pi/325*ID) + sin(2*pi/6*ID) + cos(2*pi/6*ID), data=co2, method='ML', na.action=na.omit)</div>
<p>From the ACF and PACF I consider ARMA processes up to order 3. Because the PACF is a bit ambiguous, I also include moving average processes up to order 3. </p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"></div>
 <div class="style10" style="padding-left: 30px; text-indent:-30px"> cor.results &lt;- NULL</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">for(p in 0:3) {</div>
<div class="style10" style="padding-left: 60px; text-indent:-30px"> for(q in 0:3) {</div>
<div class="style10" style="padding-left: 90px; text-indent:-30px"> if(p&gt;0 | q&gt;0) {</div>

<div class="style10" style="padding-left: 120px; text-indent:-30px">cor.temp &lt;- update(out.g, correlation=corARMA(p=p, q=q, form = ~ ID))</div>
<div class="style10" style="padding-left: 120px; text-indent:-30px">cor.results &lt;- rbind(cor.results, c(p, q, logLik(cor.temp), AIC(cor.temp))) }</div>
<div class="style10" style="padding-left: 90px; text-indent:-30px">}</div>
<div class="style10" style="padding-left: 60px; text-indent:-30px">}</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> cor.results2 &lt;- rbind(c(0,0, logLik(model5), AIC(model5)), cor.results)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> colnames(cor.results2) &lt;- c('p','q','LL','AIC')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> cor.results2</div>
<span class="style24">  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p q&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AIC<br>
  &nbsp;[1,] 0 0 -510.0550 1040.1099<br>
  &nbsp;[2,] 0 1 -324.1492&nbsp; 670.2985<br>
  &nbsp;[3,] 0 2 -260.6680&nbsp; 545.3360<br>
  &nbsp;[4,] 0 3 -223.3909&nbsp; 472.7818<br>
  &nbsp;[5,] 1 0 -169.3214&nbsp; 360.6429<br>
  &nbsp;[6,] 1 1 -156.9674&nbsp; 337.9348<br>
  &nbsp;[7,] 1 2 -155.8479&nbsp; 337.6958<br>
  &nbsp;[8,] 1 3 -155.8348&nbsp; 339.6697<br>
  &nbsp;[9,] 2 0 -159.4348&nbsp; 342.8696<br>
  [10,] 2 1 -155.8277&nbsp; 337.6554<br>
  [11,] 2 2 -155.8166&nbsp; 339.6332<br>
  [12,] 2 3 -155.8134&nbsp; 341.6267<br>
  [13,] 3 0 -156.0176&nbsp; 338.0353<br>
  [14,] 3 1 -155.8686&nbsp; 339.7372<br>
  [15,] 3 2 -155.7893&nbsp; 341.5785<br>
[16,] 3 3 -144.5356&nbsp; </span><span class="style25">321.0711
</span>
<p>We see a large drop in AIC from <span class="style8">model5</span> (p=0, q=0) to an AR(1) model and then to an ARMA(1,1) model. There is no additional improvement until the last model examined, the ARMA(3,3) model, which ranks best. I refit that model as <span class="style8">model6</span>.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model6 &lt;- update(out.g, correlation=corARMA(p=3, q=3, form=~ID))</div>
<h2>Question 10</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px">data1 &lt;- data.frame(res=residuals(model6, type='normalized'), ID=co2$ID[!is.na(co2$average)])</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> acf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 6 residuals', side=3, line=.5, cex=1)</div>
<p>Fig. 8a shows the ACF of the normalized residuals. There are still a number of significant spikes at various lags. We haven't been correcting for the large number of tests that we've been doing. Because we've included a period 325 term determined on the basis of examining an ACF, I feel justified in including a Bonferroni correction for 325 tests (Fig. 8b).</p>
<table width="675" border="0" align="center">
  <tr>
    <td><div align="center">(a) <img src="../../images/assignments/assignment6/fig8a.png" alt="fig 8a" width="275" height="230" align="texttop"></div></td>
    <td>(b)<img src="../../images/assignments/assignment6/fig8b.png" alt="fig. 8b" width="300" height="230" align="texttop"></td>
  </tr>
  <tr>
    <td colspan="2" class="styleArial"><p align="left" class="styleArial" style="padding-left: 45px; text-indent:-45px"><strong>Fig. 8</strong> &nbsp;ACF for the ARMA(3,3) quadratic model with three periodic terms using (a) alpha = .05 and (b) alpha = .05/325, a Bonferroni correction to account for testing at 325 different lags.</p></td>
  </tr>
</table>
<p>So, even with such a large Bonferroni correction there remains a significant spike at lag 12. Apparently the trig terms have not adequately accounted for the annual cycle.</p>
<h2>Question 11</h2>
<p>I replace the ARMA(3,3) model with an AR(12) model.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> model7 &lt;- update(out.g, correlation=corARMA(p=12, q=0, form=~ID))</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> AIC(model7) </div>
<span class="style24">[1] 331.361</span>
<div class="style10" style="padding-left: 30px; text-indent:-30px">data1 &lt;- data.frame(res=residuals(model7, type='normalized'), ID=co2$ID[!is.na(co2$average)])</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data2 &lt;- data.frame(ID=co2$ID)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> data3 &lt;- merge(data1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> acf(data3$res, na.action=na.pass, main='')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 7 residuals', side=3, line=.5, cex=1)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">acf(data3$res, na.action=na.pass, main='', ci=1-.05/30)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> mtext('Model 7 residuals (Bonferroni correction for 30 tests)', side=3, line=.5, cex=.9)</div>
<p>Now a fairly modest Bonferroni correction removes the significance of the spike at lag 12.</p>
<table width="675" border="0" align="center">
  <tr>
    <td><div align="center">(a) <img src="../../images/assignments/assignment6/fig9a.png" alt="fig 9a" width="275" height="230" align="texttop"></div></td>
    <td>(b)<img src="../../images/assignments/assignment6/fig9b.png" alt="fig 9b" width="300" height="230" align="texttop"></td>
  </tr>
  <tr>
    <td colspan="2" class="styleArial"><p align="left" class="styleArial" style="padding-left: 45px; text-indent:-45px"><strong>Fig. 9</strong> &nbsp;ACF for the AR(12) quadratic model with three periodic terms using (a) alpha = .05 and (b) alpha = .05/30, a Bonferroni correction to account for testing at 30 different lags.</p></td>
  </tr>
</table>
<h2>Question 12</h2>
<div class="style10" style="padding-left: 30px; text-indent:-30px">plot(average~decimal.date, data=co2, ylab=expression(paste('CO'[2],' level')), xlab='Year', type='l', lwd=2, col='grey70')</div>
<div class="style15" style="padding-left: 30px; text-indent:-30px">#reintroduce missing values into the predicted values time series</div>

<div class="style10" style="padding-left: 30px; text-indent:-30px"> pred1 &lt;- data.frame(pred=predict(model7), ID=co2$ID[!is.na(co2$average)])</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> pred3 &lt;- merge(pred1, data2, all=T)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> pred3[1:6,]</div>
<span class="style24">  &nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp; pred<br>
  1&nbsp; 1 316.0438<br>
  2&nbsp; 2 317.0623<br>
  3&nbsp; 3 317.6913<br>
  4&nbsp; 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NA<br>
  5&nbsp; 5 315.5368<br>
6&nbsp; 6 313.4073</span>
<div class="style10" style="padding-left: 30px; text-indent:-30px">lines(co2$decimal.date, pred3$pred, col=2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">legend('topleft', c('raw data', 'model'), col=c('grey70',2), lty=c(1,1), lwd=c(2,1), cex=.9, bty='n')</div><br>
<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig10.png" width="460" height="300" alt="fig. 10"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 10 </strong> &nbsp; Plot of model predictions and the raw data</p></td>
  </tr>
</table>
<p>I zoom in on a the more recent portion of the plot to get a better sense of the fit.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px">plot(average~decimal.date, data=co2[co2$decimal.date&gt;=2000,], ylab=expression(paste('CO'[2],' level')), xlab='Year', type='l',lwd=2,col='grey70')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> lines(co2$decimal.date[co2$decimal.date&gt;=2000], pred3$pred[co2$decimal.date&gt;=2000], col=2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">legend('topleft', c('raw data', 'model'), col=c('grey70',2), lty=c(1,1), lwd=c(2,1), cex=.9, bty='n')</div><br>

<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig11.png" width="460" height="305" alt="fig. 11"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 11 </strong> &nbsp; Plot of model predictions and the raw data for 2000 &ndash; 2012</p></td>
  </tr>
</table>
<p>It appears that there is a degree of irregularity to the annual cycle that we fail to match. The amplitude varies slightly over time. If we had some useful time-dependent predictors we might be able to explain this deviation from a purely sinusoidal pattern.</p>
<p>The standard tool for detecting signals in time series is the periodogram (spectrum). If we examine the spectrum of the residuals of the quadratic model, the three cycles we found are seen as being the dominant cycles. (I refit the model to the interpolated data because the spectrum function does not permit missing data.) This is further justification for the model we've fit.</p>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> out2 &lt;- lm(interpolated~decimal.date + I(decimal.date^2), data=co2)</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">out.sp &lt;- spectrum(residuals(out2), spans=3, log='no')</div>
<div class="style10" style="padding-left: 30px; text-indent:-30px">1/out.sp$freq[out.sp$spec&gt;30]</div>
<span class="style24">  [1] 324.00000  12.22642  12.00000  11.78182   6.00000</span>
<div class="style10" style="padding-left: 30px; text-indent:-30px"> plot(1/out.sp$freq, out.sp$spec, type='h', ylab='spectrum', xlab='period', col=2, lwd=2)</div><br>
<table width="500" border="0" align="center">
  <tr>
    <td><div align="center"><img src="../../images/assignments/assignment6/fig12.png" width="460" height="300" alt="fig. 12"></div></td>
  </tr>
  <tr>
    <td class="styleArial"><p style="padding-left: 50px; text-indent:-50px"><strong>Fig. 12 </strong> &nbsp;&nbsp;Spectrum of the residuals from the quadratic model</p></td>
  </tr>
</table>
<div class="style10" style="padding-left: 30px; text-indent:-30px"></div>
<hr align="center" width="75%">
<p align="center"><img src="../../images/assignments/assignment6/hwscores.png" width="355" height="200" alt="hw scores"></p>
<p align="center"><a href="../../index.html">Course Home Page</a> </p>
<!--Standard footer follows -->
<p></p>
<table width="586" border="3" cellspacing="2" cellpadding="2" align=
"CENTER">
  <tr bgcolor="#CCCCCC">
    <td width="100%"><font size=-1>Jack Weiss<br>
      <i>Phone: </i>(919) 962-5930<br>
      <i>E-Mail:</i> jack_weiss@unc.edu<br>
      <i>Address: </i>Curriculum for the Environment and Ecology, Box 3275, University of North Carolina, Chapel Hill, 27599<br>
      Copyright &copy; 2012<br>
      Last Revised--March 1, 2012<br>
      URL: <a href="assign6.htm#assign6" target="_self">https://sakai.unc.edu/access/content/group/2842013b-58f5-4453-aa8d-3e01bacbfc3d/public/Ecol562_Spring2012/docs/solutions/assign6.htm</a></font></td>
  </tr>
</table>
<p align="center">&nbsp;</p>
</body>
</html>
